<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <script>
      window.addEventListener('error', (event) => {
        log({ error: String(event.error) });
      });
      window.addEventListener('unhandledrejection', (event) => {
        log({ error: String(event.reason) });
      });

      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const audioContext = new AudioContext();

      document.addEventListener('DOMContentLoaded', () => {
        const button = document.createElement('button');
        button.appendChild(document.createTextNode('Start'));
        document.body.appendChild(button);
        button.addEventListener('click', () => {
          button.remove();
          send({ type: 'READY' });
        });
      });

      window.addEventListener('message', (event) => {
        const data = JSON.parse(String(event.data));
        switch (data.type) {
          case 'LOG': {
            logToPage(data.value);
            break;
          }
          case 'AUDIO_CHUNK': {
            const chunk = fromBase64(data.value);
            log('>> Playing chunk of length', chunk.byteLength);
            playPCM(new Float32Array(chunk));
            break;
          }
          case 'AUDIO_DONE': {
            // TODO: Teardown audioContext?
            break;
          }
        }
      });

      function playPCM(float32Array) {
        const audioBuffer = audioContext.createBuffer(
          1, // mono channel
          float32Array.length,
          16000, // sample rate
        );
        audioBuffer.getChannelData(0).set(float32Array);
        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);
        source.start();
      }

      function toBinaryString(str) {
        try {
          return atob(str);
        } catch (e) {
          log({ error: String(e), str });
        }
        return '';
      }

      function fromBase64(str) {
        const binaryString = toBinaryString(str);
        const bytes = Uint8Array.from(binaryString, (ch) => ch.charCodeAt(0));
        return bytes.buffer;
      }

      function send(value) {
        window.ReactNativeWebView.postMessage(JSON.stringify(value));
      }

      function log(...args) {
        send({ type: 'LOG', args });
      }

      function logToPage(value) {
        const code = document.createElement('code');
        code.appendChild(document.createTextNode(String(value)));
        const pre = document.createElement('pre');
        pre.appendChild(code);
        document.body.appendChild(pre);
      }
    </script>
  </body>
</html>
